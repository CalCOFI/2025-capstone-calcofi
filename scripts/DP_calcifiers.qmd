```{r}
library(tidyverse)
library(sf)
library(maps)
library(ggplot2)
```


```{r}
# zooDB data
# remove rows without line, station, or date
# create year and month columns
# create Station_ID column

mollusca1 <- read.csv("../data/ZooDB/mollusca_euthecosomata.txt", skip = 5) %>%
  filter(Line != 'N/A', Station != 'N/A', Date != 'N/A') %>%
  mutate(month = month(Date), year = year(Date)) %>%
  mutate(Station_ID = paste(
    sprintf('%05.1f', as.numeric(Line)),
    sprintf('%05.1f', as.numeric(Station)),
    sep = ' '))
mollusca2 <- read.csv("../data/ZooDB/mollusca_gymnosaomata.txt", skip = 5) %>%
  filter(Line != 'N/A', Station != 'N/A', Date != 'N/A') %>%
  mutate(month = month(Date), year = year(Date)) %>%
  mutate(Station_ID = paste(
    sprintf('%05.1f', as.numeric(Line)),
    sprintf('%05.1f', as.numeric(Station)),
    sep = ' '))
mollusca3 <- read.csv("../data/ZooDB/mollusca_heteropoda_atlantidae.txt", skip = 5) %>%
  filter(Line != 'N/A', Station != 'N/A', Date != 'N/A') %>%
  mutate(month = month(Date), year = year(Date)) %>%
  mutate(Station_ID = paste(
    sprintf('%05.1f', as.numeric(Line)),
    sprintf('%05.1f', as.numeric(Station)),
    sep = ' '))
mollusca4 <- read.csv("../data/ZooDB/mollusca_pseudothecosomata.txt", skip = 5) %>%
  filter(Line != 'N/A', Station != 'N/A', Date != 'N/A') %>%
  mutate(month = month(Date), year = year(Date)) %>%
  mutate(Station_ID = paste(
    sprintf('%05.1f', as.numeric(Line)),
    sprintf('%05.1f', as.numeric(Station)),
    sep = ' '))
ostracoda <- read.csv("../data/ZooDB/ostracoda.txt", skip = 5) %>%
  filter(Line != 'N/A', Station != 'N/A', Date != 'N/A') %>%
  mutate(month = month(Date), year = year(Date)) %>%
  mutate(Station_ID = paste(
    sprintf('%05.1f', as.numeric(Line)),
    sprintf('%05.1f', as.numeric(Station)),
    sep = ' '))
radiolaria <- read.csv("../data/ZooDB/radiolaria.txt", skip = 5) %>%
  filter(Line != 'N/A', Station != 'N/A', Date != 'N/A') %>%
  mutate(month = month(Date), year = year(Date)) %>%
  mutate(Station_ID = paste(
    sprintf('%05.1f', as.numeric(Line)),
    sprintf('%05.1f', as.numeric(Station)),
    sep = ' '))
foraminifera <- read.csv("../data/ZooDB/foraminifera.txt", skip = 5) %>%
  filter(Line != 'N/A', Station != 'N/A', Date != 'N/A') %>%
  mutate(month = month(Date), year = year(Date)) %>%
  mutate(Station_ID = paste(
    sprintf('%05.1f', as.numeric(Line)),
    sprintf('%05.1f', as.numeric(Station)),
    sep = ' '))
```


```{r}
# PRPOOS data

byrozoan <- read.csv('../data/PRPOOS/byrozoan_larvae.csv', skip = 2) %>%
  filter(Line != 'N/A', Station != 'N/A', Station.date != 'N/A') %>%
  mutate(month = month(Station.date), year = year(Station.date)) %>%
  mutate(Station_ID = paste(
    sprintf('%05.1f', as.numeric(Line)),
    sprintf('%05.1f', as.numeric(Station)),
    sep = ' '))

ostracods <- read.csv('../data/PRPOOS/ostracods.csv', skip = 2) %>%
  filter(Line != 'N/A', Station != 'N/A', Station.date != 'N/A') %>%
  mutate(month = month(Station.date), year = year(Station.date)) %>%
  mutate(Station_ID = paste(
    sprintf('%05.1f', as.numeric(Line)),
    sprintf('%05.1f', as.numeric(Station)),
    sep = ' '))

pteropoda <- read.csv('../data/PRPOOS/pteropoda_heteropoda.csv', skip = 2) %>%
  filter(Line != 'N/A', Station != 'N/A', Station.date != 'N/A') %>%
  mutate(month = month(Station.date), year = year(Station.date)) %>%
  mutate(Station_ID = paste(
    sprintf('%05.1f', as.numeric(Line)),
    sprintf('%05.1f', as.numeric(Station)),
    sep = ' '))

rhizaria <- read.csv('../data/PRPOOS/rhizaria.csv', skip = 2) %>%
  filter(Line != 'N/A', Station != 'N/A', Station.date != 'N/A') %>%
  mutate(month = month(Station.date), year = year(Station.date)) %>%
  mutate(Station_ID = paste(
    sprintf('%05.1f', as.numeric(Line)),
    sprintf('%05.1f', as.numeric(Station)),
    sep = ' '))
```



```{r}
# CO2SYS data
# filter depth < 212

co2sys <- read.csv('../data/merged_bottle_co2sys.csv') %>%
  filter(Depth < 212) 
```


```{r}
# merge zooDB data
# merge on Station_ID, Year, and Month

mollusca1_co2sys <- inner_join(
  mollusca1,
  co2sys,
  by = join_by(Station_ID, year == Year_UTC, month == Month_UTC)
)

mollusca2_co2sys <- inner_join(
  mollusca2,
  co2sys,
  by = join_by(Station_ID, year == Year_UTC, month == Month_UTC)
)

mollusca3_co2sys <- inner_join(
  mollusca3,
  co2sys,
  by = join_by(Station_ID, year == Year_UTC, month == Month_UTC)
)

mollusca4_co2sys <- inner_join(
  mollusca4,
  co2sys,
  by = join_by(Station_ID, year == Year_UTC, month == Month_UTC)
)

ostracoda_co2sys <- inner_join(
  ostracoda,
  co2sys,
  by = join_by(Station_ID, year == Year_UTC, month == Month_UTC)
)

radiolaria_co2sys <- inner_join(
  radiolaria,
  co2sys,
  by = join_by(Station_ID, year == Year_UTC, month == Month_UTC)
)

foraminifera_co2sys <- inner_join(
  foraminifera,
  co2sys,
  by = join_by(Station_ID, year == Year_UTC, month == Month_UTC)
)
```

```{r}
# merge PRPOOS data

byrozoan_co2sys <- inner_join(
  byrozoan,
  co2sys,
  by = join_by(Station_ID, year == Year_UTC, month == Month_UTC)
)

ostracods_co2sys <- inner_join(
  ostracods,
  co2sys,
  by = join_by(Station_ID, year == Year_UTC, month == Month_UTC)
)

pteropoda_co2sys <- inner_join(
  pteropoda,
  co2sys,
  by = join_by(Station_ID, year == Year_UTC, month == Month_UTC)
)

rhizaria_co2sys <- inner_join(
  rhizaria,
  co2sys,
  by = join_by(Station_ID, year == Year_UTC, month == Month_UTC)
)
```


```{r}
rhizaria_by_station <- aggregate(rhizaria_co2sys[, 'Abundance..No..per.m2.'],
                                 list(rhizaria_co2sys$Latitude,
                                      rhizaria_co2sys$Longitude),
                                 mean) %>%
  rename(latitude = Group.1, longitude = Group.2, abundance = x)

rhizaria_by_station
```

```{r}
# distance from shore 
distance_from_shore <- data.frame(
  latitude = c(30.4179, 32.8167, 33.1500, 33.4833, 31.4179, 33.8167, 31.7513, 34.1500, 34.3167, 34.4500, 32.4179, 32.6513, 32.9179, 33.1846, 33.4179, 33.4846),
  longitude = c(-123.9989, -123.9060, -123.2210, -122.5333, -121.9900, -121.8430, -121.3156, -121.1500, -120.8024, -120.5239, -119.9593, -119.4823, -118.9355, -118.3871, -117.9058, -117.7681),
  distance = c(682, 367, 293, 219, 461, 145, 387, 72, 35, 5, 239, 187, 128, 69, 18, 3)
)

# add distance from shore to each dataset
inner_join(rhizaria_by_station,
          distance_from_shore,
          by = join_by(latitude, longitude))
```

```{r}
distance_from_shore
```


```{r}
ggplot(rhizaria_by_station, aes(x = longitude, y = latitude)) + 
  geom_point(aes(col = abundance))
```


```{r}
co2sys <- read.csv('../data/merged_bottle_co2sys.csv')

depth_omega <- co2sys %>%
  select('Depth', 'OmegaCAin', 'OmegaARin') %>%
  drop_na() %>%
  mutate(log_Depth = log(Depth))

depth_omega
```

```{r}
# count by station
co2sys_stations <- co2sys %>% 
  group_by(Station_ID) %>% 
  count() %>% 
  filter(n > 200) %>% 
  select(Station_ID)

# partition co2sys data by station
stations <- unique(co2sys_stations$Station_ID)

for (station in stations){
  assign(paste0('co2sys_', station), subset(co2sys, Station_ID == station) %>%
    select('Station_ID', 'Year_UTC', 'Depth', 'OmegaCAin', 'OmegaARin') %>%
    drop_na())
}
```


```{r}
# calcium
# plot for station 90.90
years <- 2007:2025

for (year in years){
  p <- ggplot(data = `co2sys_090.0 090.0` %>% filter(Year_UTC == year),
              aes(x = OmegaCAin, y = Depth)) + 
    geom_point(alpha = 0.5) + 
    geom_smooth(method = "gam", formula = y ~ s(x), color = "red", se = FALSE) +
    scale_y_reverse() +
    labs(
      title = paste('Scatter Plot for Year', year),
      x = 'OmegaCA',
      y = 'Depth (m)'
    )
    theme_minimal()
  
  plot(p)
}
```

```{r}
# aragonite
# station 90.90

years <- 2007:2025

for (year in years){
  p <- ggplot(data = `co2sys_090.0 090.0` %>% filter(Year_UTC == year),
              aes(x = OmegaARin, y = Depth)) + 
    geom_point(alpha = 0.5) + 
    geom_smooth(method = "gam", formula = y ~ s(x), color = "red", se = FALSE) +
    scale_y_reverse() +
    labs(
      title = paste('Scatter Plot for Year', year),
      x = 'OmegaAR',
      y = 'Depth (m)'
    )
    theme_minimal()
  
  plot(p)
}

```



```{r}
# plot for station 80.55
years <- 2007:2025

for (year in years){
  p <- ggplot(data = `co2sys_080.0 055.0` %>% filter(Year_UTC == year),
              aes(x = OmegaCAin, y = Depth)) + 
    geom_point(alpha = 0.5) + 
    geom_smooth(method = "gam", formula = y ~ s(x), color = "red", se = FALSE) +
    scale_y_reverse() +
    labs(
      title = paste('Scatter Plot for Year', year),
      x = 'OmegaCA',
      y = 'Depth (m)'
    )
    theme_minimal()
  
  plot(p)
}
```













```{r}
pteropoda %>%
  arrange(Cruise, Station_ID, Cruise.mid.date, Local.time..PST.)
```






