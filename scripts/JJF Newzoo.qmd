---
title: "Untitled"
format: html
editor: visual
---
## New Merge(new data)
```{r}
# Load libraries
library(readr)
library(dplyr)
library(lubridate)
# Load data
oah_bottle <- read_csv("~/Desktop/Pstat197BC/capstone-calcofi-seagrant/data/carbonate_chem_bottle.csv")
new_zooplankton <- read_csv("~/Desktop/Pstat197BC/capstone-calcofi-seagrant/data/Zooplankton-new.csv")

```
#### 1.`Year_UTC`, `Month_UTC`, `Day_UTC`, `Time_UTC` ↔ time
Fix Time_UTC issue → Time_UTC of oah_bottle is all 00:00:00, so just ignore it and join with Date.
```{r}
oah_bottle <- oah_bottle %>%
  mutate(
    Year_UTC = as.integer(Year_UTC),
    Month_UTC = as.integer(Month_UTC),
    Day_UTC = as.integer(Day_UTC)
  )

# one NA line
oah_bottle <- oah_bottle %>%
  filter(!is.na(Year_UTC) & !is.na(Month_UTC) & !is.na(Day_UTC))
```

```{r}
# Keep only the date part
oah_bottle <- oah_bottle %>%
  mutate(Date = as.Date(paste(Year_UTC, Month_UTC, Day_UTC, sep = "-"), format = "%Y-%m-%d"))

#oah_bottle$Date

new_zooplankton <- new_zooplankton %>%
  mutate(Date = as.Date(time))

#new_zooplankton$Date

# Check matching
intersect(as.character(unique(oah_bottle$Date)), as.character(unique(new_zooplankton$Date)))
```

#### 2.Station_ID (CALCOFI)  ↔ 0+ line + 0+ station 
Unify Station_ID format and remove spaces in Station_ID in oah_bottle.
```{r}
str(new_zooplankton$line)
str(new_zooplankton$station)

# they are numeric, not integer. so convert!!!
new_zooplankton <- new_zooplankton %>%
  mutate(line = as.integer(line), station = as.integer(station))

```

```{r}
# clean oah_bottle `Station_ID`
oah_bottle <- oah_bottle %>%
  mutate(Station_ID = str_replace_all(Station_ID, "\\s+", ""))  # delete space

# new_zooplankton  `Station_ID`
new_zooplankton <- new_zooplankton %>%
  mutate(Station_ID = paste0(
    str_pad(as.integer(line), 3, pad = "0"), ".",  
    str_pad(as.integer(station), 4, pad = "0"), ".0"
  )) %>%
  select(-line, -station)

# Check matching
intersect(unique(oah_bottle$Station_ID), unique(new_zooplankton$Station_ID))

```
#### 3. Latitude, Longitude (CALCOFI) ↔ latitude, longitude
Make sure Latitude / Longitude are numeric types to prevent join failure.
```{r}
# oah_bottle's Latitude and Longitude are object type, convert to num
oah_bottle <- oah_bottle %>%
  mutate(Latitude = as.numeric(Latitude),
         Longitude = as.numeric(Longitude))

new_zooplankton <- new_zooplankton %>%
  mutate(latitude = round(latitude, 4),
         longitude = round(longitude, 4))


# Check matching
sum(oah_bottle$Latitude %in% new_zooplankton$latitude)
sum(oah_bottle$Longitude %in% new_zooplankton$longitude)

```

#### Aggregate oah_bottle by Date
Because oah_bottle is hourly data and new_zooplankton is daily data, oah_bottle must be aggregated first.
```{r}
oah_bottle_daily <- oah_bottle %>%
  group_by(Station_ID, Latitude, Longitude, Date, Ship_Name) %>%
  summarise(
    avg_DIC = mean(as.numeric(DIC), na.rm = TRUE),
    avg_Salinity = mean(as.numeric(Salinity_PSS78), na.rm = TRUE),
    avg_Temperature = mean(as.numeric(CTDTEMP_ITS90), na.rm = TRUE),
    .groups = "drop"
  )


head(oah_bottle_daily)
```

#### 4.Ship_Name ↔ ship 
```{r}
oah_bottle_daily <- oah_bottle_daily %>%
  mutate(Ship_Name_clean = str_to_upper(Ship_Name) %>% str_replace("^RV\\s+", ""))

new_zooplankton <- new_zooplankton %>%
  mutate(ship_clean = str_to_upper(ship))


intersect(unique(oah_bottle_daily$Ship_Name_clean), unique(new_zooplankton$ship_clean))

```

#### left_join()
```{r}
merged_data_1 <- new_zooplankton %>%
  inner_join(oah_bottle_daily, by = c("Station_ID", 
                                "latitude" = "Latitude", 
                                "longitude" = "Longitude", 
                                "Date",
                                "ship_clean" = "Ship_Name_clean"))


head(merged_data_1)
```

```{r}
merged_data_2 <- oah_bottle_daily %>%
  full_join(new_zooplankton, by = c("Station_ID", 
                                    "Latitude" = "latitude", 
                                    "Longitude" = "longitude", 
                                    "Date",
                                    "Ship_Name_clean" = "ship_clean"))

filter(merged_data_2, is.na(volume_sampled) & !is.na(avg_DIC))

```
```{r}
colSums(is.na(merged_data_2)) 
```

