---
title: "krill_eda_liuqian"
output: html_document
---

# omegaCA 
```{r}
library(readr)
library(dplyr)
library(lubridate)
merged_bottle_co2sys <- read_csv("../data/merged_bottle_co2sys.csv")

mollusca1 <- read_csv(here::here("data/ZooDB/mollusca_euthecosomata.txt"), skip = 5)
mollusca2 <- read_csv(here::here("data/ZooDB/mollusca_gymnosaomata.txt"), skip = 5)
mollusca3 <- read_csv(here::here("data/ZooDB/mollusca_heteropoda_atlantidae.txt"), skip = 5)
mollusca4 <- read_csv(here::here("data/ZooDB/mollusca_pseudothecosomata.txt"), skip = 5)
ostracoda <- read_csv(here::here("data/ZooDB/ostracoda.txt"), skip = 5)
radiolaria <- read_csv(here::here("data/ZooDB/radiolaria.txt"), skip = 5)
foraminifera <- read_csv(here::here("data/ZooDB/foraminifera.txt"), skip = 5)
```

```{r}
# format Station_ID column
mollusca1$Station_ID <- paste(
  sprintf('%05.1f', as.numeric(mollusca1$Line)),
  sprintf('%05.1f', as.numeric(mollusca1$Station)),
  sep = ' '
)

mollusca1_unpool <- mollusca1 %>% 
  filter(Source == "Unpooled") %>% 
  na.omit()

mollusca1_unpool <- mollusca1_unpool %>%
  mutate(
    Year = year(Date),
    Month = month(Date),
    Day = day(Date)
  )

merged_bottle_co2sys <- merged_bottle_co2sys %>% mutate(DIC = as.numeric(DIC),
                                  TA = as.numeric(TA),
                                  Depth = as.numeric(Depth),
                                  CTDTEMP_ITS90 = as.numeric(CTDTEMP_ITS90),
                                  Salinity_PSS78 = as.numeric(Salinity_PSS78),
                                  Longitude = as.numeric(Longitude),
                                  Latitude = as.numeric(Latitude)
                                  )
```

```{r}
# merge
mollusca1_unpool_merged <- inner_join(
  merged_bottle_co2sys, 
  mollusca1_unpool,
  by = join_by(Year_UTC == Year, Station_ID == Station_ID)
)
# no matching
```

```{r}
# eda plots
ggplot() +
  geom_point(aes(x = Date, y = Station_ID, color = "ZooDB Data"), 
             alpha = 0.7, data = mollusca1_unpool) +
  geom_point(aes(x = Date_cc, y = Station_ID, color = "CO2SYS Data"), 
             alpha = 0.7, data = merged_bottle_co2sys) +
  scale_color_manual(values = c("ZooDB Data" = "red", "CO2SYS Data" = "blue")) +
  labs(color = "Dataset") +
  theme_minimal()

```

# PRPOOS
## data/PRPOOS
```{r message=FALSE}
# Read in datasets
byrozoan_larvae <- read_csv(here::here("data/PRPOOS/byrozoan_larvae.csv"), skip = 2)
pteropoda_heteropoda <- read_csv(here::here("data/PRPOOS/pteropoda_heteropoda.csv"), skip = 2)
ostracods <- read_csv(here::here("data/PRPOOS/ostracods.csv"), skip = 2)
rhizaria <- read_csv(here::here("data/PRPOOS/rhizaria.csv"), skip = 2)
```

```{r}
library(dplyr)
library(lubridate)

# Step 1: Put your datasets into a named list
data_list <- list(
  byrozoan_larvae = byrozoan_larvae,
  pteropoda_heteropoda = pteropoda_heteropoda,
  ostracods = ostracods,
  rhizaria = rhizaria
)

# Step 2: Loop through the list and preprocess each
data_list <- lapply(data_list, function(df) {
  df$Station_ID <- paste(
    sprintf('%05.1f', df$Line),
    sprintf('%05.1f', df$Station),
    sep = ' '
  )
  
  df <- df %>%
    relocate(Station_ID, .after = Line) %>%
    mutate(
      Year_UTC = year(`Station date`),
      Month_UTC = month(`Station date`),
      Day_UTC = day(`Station date`),
      .after = `Station date`
    ) %>%
    rename(Abundance = `Abundance (No. per m2)`)
  
  return(df)
})
byrozoan_larvae <- data_list$byrozoan_larvae
pteropoda_heteropoda <- data_list$pteropoda_heteropoda
ostracods <- data_list$ostracods
rhizaria <- data_list$rhizaria

```

# all taxa of Prpoos data
```{r}
prpoos_summary <- read_csv("../data/PRPOOS/prpoos_summary.csv")
```

```{r}
library(dplyr)
library(stringr)

# Clean column names by removing units and converting to camelCase style
colnames(prpoos_summary) <- colnames(prpoos_summary) %>%
  str_replace(" Abundance \\(No\\. per m2\\)", "Abundance") %>%
  str_replace(" Estimated C Biomass \\(mgC m-2\\)", "EstimatedBiomass") %>%
  str_replace_all(" ", "")  # Remove any remaining spaces
write.csv(prpoos_summary, "../data/PRPOOS/prpoos_summary_namecleaned.csv", row.names = FALSE)
names(prpoos_summary)
```

## eda plots
```{r}
library(dplyr)
library(tidyr)
library(ggplot2)

# Define taxa to highlight
highlight_taxa <- c("bryozoan_larvae", "pteropoda_heteropoda", "ostracods", "rhizaria")

# Prepare data
long_df <- prpoos_summary %>%
  select(contains("Abundance"), OmegaCA_mean) %>%
  pivot_longer(
    cols = ends_with("Abundance"),
    names_to = "Taxa",
    values_to = "Abundance"
  ) %>%
  mutate(
    Taxa = gsub("Abundance$", "", Taxa),
    highlight = ifelse(Taxa %in% highlight_taxa, "Highlighted", "Normal")
  )

# Plot with color based on highlight status
ggplot(long_df, aes(x = OmegaCA_mean, y = Abundance, color = highlight)) +
  geom_point(alpha = 0.3, size = 0.2) +
  facet_wrap(~ Taxa, scales = "free_y") +
  scale_color_manual(values = c("Highlighted" = "red", "Normal" = "black")) +
  labs(x = "Mean OmegaCA", y = "Abundance", title = "Abundance vs. Mean OmegaCA") +
  theme_minimal() +
  theme(legend.position = "none")  # Remove legend if not needed

```

```{r}
# Step 1: Select abundance columns + OmegaCA
abundance_df <- prpoos_summary %>%
  select(contains("Abundance"), pH_mean)

# Step 2: Reshape data into long format for easy plotting
long_df <- abundance_df %>%
  pivot_longer(
    cols = ends_with("Abundance"),
    names_to = "Taxa",
    values_to = "Abundance"
  )
long_df$Taxa <- gsub("Abundance$", "", long_df$Taxa)

# Step 3: Plot all abundance variables vs. mean OmegaCA using facets
ggplot(long_df, aes(x = pH_mean, y = Abundance)) +
  geom_point(alpha = 0.3, size = 0.2) +
  facet_wrap(~ Taxa, scales = "free_y") +
  labs(x = "Mean pH", y = "Abundance", title = "Abundance vs. Mean pH") +
  theme_minimal()
```

